<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
</head>

<body>
<div layout:fragment="content" class="content-inner chart-cont" style="height:100vh">
    <!--***** CONTENT *****-->
    <div class="row">
        <div class="col-md-12">
            <div class="card form" id="form1">
                <div class="card-header">
                    <h3>배송준비중 관리</h3>
                </div>
                <br>

                <div class="table-responsive">
                    <form th:name="orderSearch" th:action="@{/admin/orders/readyOrderList}" th:method="GET">
                    <table class="table table-bordered">
                        <tr>
                            <td>주문번호</td>
                            <td><input type="text" th:name="orderId" class="form-control" th:value="${orderSearch.orderId}" placeholder="주문번호를 입력해주세요."></td>
                            <td rowspan="3" style="text-align: center; display: table-cell; vertical-align: inherit">
                                <button type="submit" class="btn btn-primary btn-lg">검색</button>
                            </td>
                        </tr>
                        <tr>
                            <td>상품명</td>
                            <td><input type="text" th:name="itemName" class="form-control" th:value="${orderSearch.itemName}" placeholder="상품명을 입력해주세요."></td>
                        </tr>
                        <tr>
                            <td>회원 이메일</td>
                            <td><input type="text" th:name="userEmail" class="form-control" th:value="${orderSearch.userEmail}" placeholder="회원 이메일을 입력해주세요."></td>
                        </tr>
                    </table>
                    </form>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered" th:id="t">
                        <thead>
                        <tr>
                            <th>주문번호</th>
<!--                            <th>주문일</th>-->
                            <th>주문자</th>
                            <th><input type="checkbox" id="totalCheckBox"/></th>
                            <th>상품명</th>
                            <th>수량</th>
                            <th>상품구매금액</th>
                            <th>총 실결제금액</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="orderItem, index : ${readyOrderItemList}">
                            <td th:inline="text">
                                <a th:href="@{|/admin/orders/${orderItem.order.id}|}">[[${orderItem.order.id}]]</a>
                            </td>
<!--                            <td th:text="${orderItem.order.orderDate}"></td>-->
                            <td th:inline="text">
                                [[${orderItem.order.member.username}]]<br>
                                ([[${orderItem.order.member.userEmail}]])
                            </td>
                            <td>
                                <input type="checkbox" th:name="checkBoxOrder" th:value="${orderItem.order.id}">
                            </td>
                            <td th:inline="text">
                                <a th:href="@{|/admin/items/update/${orderItem.item.id}|}">[[${orderItem.item.name}]]</a>
                            </td>
                            <td th:text="${orderItem.count}"></td>
                            <td th:text="${orderItem.totalPrice}"></td>
                            <td th:text="${orderItem.order.totalPrice}"></td>
                        </tr>
                        <tr>
                            <td colspan="8">
                                <button type="button" th:onclick="startOrder()" class="btn btn-primary">배송중 처리</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="script">
    <script type="text/javascript" th:inline="javascript">

        $(document).ready(function() {
            fn_cellMerge('t', [0,1,2,6]);
        });

        var token = $('#_csrf').attr('content');
        var header = $('#_csrf_header').attr('content');

        function startOrder() {
            var orderArr = [];
            $('input[name="checkBoxOrder"]:checked').each(function () {
                var value = $(this).val();
                orderArr.push(value);
            });
            $.ajax({
                url: '/admin/orders/start',
                data: { 'orderIdList' : orderArr },
                traditional: true,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function() {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.log("error : " + error);
                }
            })
        }

        function searchList() {
            $.ajax({
                url: '/admin/orders/start',
                data: { 'orderIdList' : orderArr },
                traditional: true,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function() {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.log("error : " + error);
                }
            })
        }

        function fn_cellMerge(vid, vcol, vtd){ //테이블 아이디, 셀머지할 컬럼 0부터~, 태그(옵션)
            var id = vid;
            var col = vcol;
            var td = ((!!vtd) ? vtd : "td"  ); // 기본이 td 태그 기준으로 merge함

            var spanCnt = 1;
            var preText; //이전 텍스트

            var r = [];

            var rows = $("table[id="+id+"] tr").find(td+":eq("+col[0]+")").length; //row 개수
            if (rows <= 1) {
                return false;
            }

            for (var i = 0; col.length > i; i++) {
                r.push({ idx : [], spans : []});
                if (i === 0) { //첫번째
                    $("table[id="+id+"] tr").find(td+":eq("+col[i]+")").each(function(index, item){// row수만큼 돌린다.
                        if(index === 0) { //첫번째 row
                            r[i].idx.push(index);
                            spanCnt = 1;
                        } else if ( (rows-1) === index) { //마지막 row
                            if(preText !== $(this).text()){ //중복없이 단일행 마지막
                                r[i].idx.push(index);
                                r[i].spans.push(spanCnt);
                            } else { //전 값이 동일한 경우
                                spanCnt = spanCnt+1;
                                r[i].spans.push(spanCnt);
                            }
                        } else if (preText !== $(this).text()) { //텍스트가 바뀔때 index
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                        } else { //위 아래 텍스트가 같을 때
                            spanCnt = spanCnt + 1;
                        }
                        preText = $(this).text();
                    });
                } else if ( !r[i-1].idx.length) { // rowSpan할 row가 없다면 종료
                    break;
                } else { //그 뒤 그룹으로
                    var j = 1; //그룹 구별자
                    $("table[id="+id+"] tr").find(td+":eq("+col[i]+")").each(function(index, item){// row수만큼 돌린다.
                        if (index === 0) { //첫번째 row
                            r[i].idx.push(index);
                            spanCnt = 1;
                        } else if (r[i-1].idx[j] === (index)) { //rowSpan 적용 시작 지점에서 리셋
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                            j++;
                        } else if ( (rows-1) === index) { //마지막 row
                            if(preText !== $(this).text()){ //중복없이 단일행 마지막
                                r[i].idx.push(index);
                                r[i].spans.push(spanCnt);
                            } else { //전 값이 동일한 경우
                                spanCnt = spanCnt+1;
                                r[i].spans.push(spanCnt);
                            }
                        } else if (preText !== $(this).text()) { //텍스트가 바뀔때 index
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                        } else { //위 아래 텍스트가 같을 때
                            spanCnt = spanCnt+1;
                        }
                        preText = $(this).text();
                    });
                }
            }

            for (var k = col.length; k > 0; k--){ //역순으로 돌려야 그룹이 안깨짐
                $("table[id="+id+"] tr").find(td+":eq("+col[k-1]+")").each(function(index, item) {
                    if (r[k-1].idx[0] === index) {
                        $(this).attr("rowspan",r[k-1].spans[0]);
                        r[k-1].idx.shift();
                        r[k-1].spans.shift();
                    } else {
                        $(this).remove();
                    }
                });
            }
        }
    </script>
</th:block>
</body>

</html>