<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
</head>

<body>
<div layout:fragment="content" class="content-inner chart-cont" style="height:100vh">
    <!--***** CONTENT *****-->
    <div class="row">
        <div class="col-md-12">
            <div class="card form" id="form1">
                <div class="card-header">
                    <h3>주문 상세</h3>
                </div>
                <br>

                <div class="col-md-12 mb-5 mb-md-0">
                    <h2 class="h3 mb-3 text-black">01 주문자 정보</h2>
                    <table class="table table-bordered">
                        <colgroup>
                            <col width="25%">
                            <col width="75">
                        </colgroup>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">주문하신 분</td>
                            <td th:text="${member.username}"></td>
                        </tr>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">휴대폰 번호</td>
                            <td th:text="${member.phone}"></td>
                        </tr>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">이메일</td>
                            <td th:text="${member.userEmail}"></td>
                        </tr>
                    </table>
                </div>

                <div class="col-md-12 mb-5 mb-md-0">
                    <h2 class="h3 mb-3 text-black">02 배송정보</h2>
                    <table class="table table-bordered">
                        <colgroup>
                            <col width="25%">
                            <col width="75">
                        </colgroup>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">주문하신 분</td>
                            <td th:text="${member.username}"></td>
                        </tr>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">휴대폰 번호</td>
                            <td th:text="${member.phone}"></td>
                        </tr>
                        <tr style="font-size:16px;">
                            <td style="text-align: center">이메일</td>
                            <td th:text="${member.userEmail}"></td>
                        </tr>
                    </table>
                </div>

                <div class="col-md-12 mb-5 mb-md-0">
                    <h2 class="h3 mb-3 text-black">03 결제정보</h2>
                    <div class="p-3 p-lg-5 border">
                        <table class="table table-bordered" style="text-align: center">
                            <thead>
                            <tr style="font-size:18px">
                                <th>주문금액</th>
                                <th>(-) 할인금액</th>
                                <th>(=) 최종 결제금액</th>
                                <th>적립 통합포인트</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr style="font-size:18px">
                                <td>
                                    <strong>{{orderDetail.totalPrice | currency}}원</strong>
                                </td>
                                <td>
                                    <strong>(-) {{orderDetail.usingPoint | currency}}원</strong>
                                </td>
                                <td>
                                    <strong>(=) <span style="color:red">{{(orderDetail.totalPrice - orderDetail.usingPoint) | currency}}원</span></strong>
                                </td>
                                <td>
                                    <strong>{{orderDetail.savingPoint | currency}}원</strong>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="form-group">
                            <a class="btn btn-primary btn-lg py-3 btn-block" th:href="/myPage">주문/배송조회 가기</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="script">
    <script type="text/javascript" th:inline="javascript">

        $(document).ready(function() {
            fn_cellMerge('t', [0,1,2,3,7]);
        });

        var token = $('#_csrf').attr('content');
        var header = $('#_csrf_header').attr('content');

        function startOrder() {
            var orderArr = [];
            $('input[name="checkBoxOrder"]:checked').each(function () {
                var value = $(this).val();
                orderArr.push(value);
            });
            $.ajax({
                url: '/admin/orders/start',
                data: { 'orderIdList' : orderArr },
                traditional: true,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function() {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.log("error : " + error);
                }
            })
        }

        function searchList() {
            $.ajax({
                url: '/admin/orders/start',
                data: { 'orderIdList' : orderArr },
                traditional: true,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function() {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.log("error : " + error);
                }
            })
        }

        function fn_cellMerge(vid, vcol, vtd){ //테이블 아이디, 셀머지할 컬럼 0부터~, 태그(옵션)
            var id = vid;
            var col = vcol;
            var td = ((!!vtd) ? vtd : "td"  ); // 기본이 td 태그 기준으로 merge함

            var spanCnt = 1;
            var preText; //이전 텍스트

            var r = [];

            var rows = $("table[id="+id+"] tr").find(td+":eq("+col[0]+")").length; //row 개수
            if (rows <= 1) {
                return false;
            }

            for (var i = 0; col.length > i; i++) {
                r.push({ idx : [], spans : []});
                if (i === 0) { //첫번째
                    $("table[id="+id+"] tr").find(td+":eq("+col[i]+")").each(function(index, item){// row수만큼 돌린다.
                        if(index === 0) { //첫번째 row
                            r[i].idx.push(index);
                            spanCnt = 1;
                        } else if ( (rows-1) === index) { //마지막 row
                            if(preText !== $(this).text()){ //중복없이 단일행 마지막
                                r[i].idx.push(index);
                                r[i].spans.push(spanCnt);
                            } else { //전 값이 동일한 경우
                                spanCnt = spanCnt+1;
                                r[i].spans.push(spanCnt);
                            }
                        } else if (preText !== $(this).text()) { //텍스트가 바뀔때 index
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                        } else { //위 아래 텍스트가 같을 때
                            spanCnt = spanCnt + 1;
                        }
                        preText = $(this).text();
                    });
                } else if ( !r[i-1].idx.length) { // rowSpan할 row가 없다면 종료
                    break;
                } else { //그 뒤 그룹으로
                    var j = 1; //그룹 구별자
                    $("table[id="+id+"] tr").find(td+":eq("+col[i]+")").each(function(index, item){// row수만큼 돌린다.
                        if (index === 0) { //첫번째 row
                            r[i].idx.push(index);
                            spanCnt = 1;
                        } else if (r[i-1].idx[j] === (index)) { //rowSpan 적용 시작 지점에서 리셋
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                            j++;
                        } else if ( (rows-1) === index) { //마지막 row
                            if(preText !== $(this).text()){ //중복없이 단일행 마지막
                                r[i].idx.push(index);
                                r[i].spans.push(spanCnt);
                            } else { //전 값이 동일한 경우
                                spanCnt = spanCnt+1;
                                r[i].spans.push(spanCnt);
                            }
                        } else if (preText !== $(this).text()) { //텍스트가 바뀔때 index
                            r[i].idx.push(index);
                            r[i].spans.push(spanCnt);
                            spanCnt = 1;
                        } else { //위 아래 텍스트가 같을 때
                            spanCnt = spanCnt+1;
                        }
                        preText = $(this).text();
                    });
                }
            }

            for (var k = col.length; k > 0; k--){ //역순으로 돌려야 그룹이 안깨짐
                $("table[id="+id+"] tr").find(td+":eq("+col[k-1]+")").each(function(index, item) {
                    if (r[k-1].idx[0] === index) {
                        $(this).attr("rowspan",r[k-1].spans[0]);
                        r[k-1].idx.shift();
                        r[k-1].spans.shift();
                    } else {
                        $(this).remove();
                    }
                });
            }
        }
    </script>
</th:block>
</body>

</html>